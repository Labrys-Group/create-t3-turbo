# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Package Overview

`@acme/db` — Standalone Drizzle ORM package for PostgreSQL (Supabase/Vercel Postgres). Provides the schema, database client, and mock database for testing. Consumed by `packages/auth` and `packages/api`.

## Commands

Run from this directory (`packages/db`):

```bash
pnpm push                  # Push schema to database (uses drizzle-kit push)
pnpm studio                # Open Drizzle Studio (visual DB editor)
pnpm typecheck             # TypeScript check
pnpm lint                  # ESLint
```

Run from the monorepo root:

```bash
pnpm db:push               # Same as pnpm push above
pnpm db:studio             # Same as pnpm studio above
pnpm auth:generate         # Regenerate Better Auth schema → src/auth-schema.ts
```

## Package Exports

Four entry points exported via `package.json` `exports`:

| Import path | File | Purpose |
|---|---|---|
| `@acme/db` | `src/index.ts` | Re-exports `drizzle-orm/sql` utilities and `alias` from `pg-core` |
| `@acme/db/client` | `src/client.ts` | Drizzle client instance (`db`) with schema and `snake_case` casing |
| `@acme/db/schema` | `src/schema.ts` | All table definitions (app tables + auth tables) |
| `@acme/db/mocks` | `src/mocks/index.ts` | `createMockDb()` — PGlite in-memory DB for tests, runs real migrations |

## Schema Conventions

- **Casing**: Drizzle is configured with `casing: "snake_case"` — use camelCase in TypeScript, Drizzle auto-converts to snake_case in SQL. Both `client.ts` and `drizzle.config.ts` set this.
- **Table definition style**: Use the callback-based `pgTable("name", (t) => ({...}))` pattern.
- **Validators**: Use `drizzle-zod`'s `createInsertSchema` to derive Zod schemas from tables. Omit auto-generated fields (`id`, `createdAt`, `updatedAt`).
- **Auth schema** (`src/auth-schema.ts`): Auto-generated by Better Auth — do **not** edit manually. Regenerate with `pnpm auth:generate` from the root.
- **App schema** (`src/schema.ts`): Add new application tables here. Re-exports auth-schema via `export * from "./auth-schema"`.

## Database Connection

- Uses `@vercel/postgres` driver with `drizzle-orm/vercel-postgres` adapter (edge-compatible).
- Requires `POSTGRES_URL` environment variable. The `drizzle.config.ts` swaps port 6543 (pooler) to 5432 (direct) for migrations.
- All commands use `with-env` script to load `../../.env` via `dotenv`.

## Mock Database for Tests

`createMockDb()` in `src/mocks/client.ts` spins up PGlite (in-memory PostgreSQL) and runs the actual migrations from `drizzle/`. Tests get a real SQL-compatible database without external dependencies. Used in `packages/api` tests.

## Migrations

SQL migrations live in `drizzle/` with metadata in `drizzle/meta/`. Generated by drizzle-kit. The mock database depends on these files — keep migrations up to date when changing schema.
